<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Cámara</title>
    <style>
      #camara {
        object-fit: cover;
        width: 100%;
        height: 100%;
      }

      .cuadro {
        display: inline-block;
        width: 50px;
        height: 50px;
        margin: 5px;
        text-align: center;
        line-height: 50px;
        font-size: 24px;
        color: #fff;
        background-color: #333;
      }

      .cuadro.verde {
        background-color: green;
      }
    </style>
  </head>
  <body>
    <div id="letras-container">
      <div class="cuadro">A</div>
      <div class="cuadro">B</div>
      <div class="cuadro">C</div>
      <div class="cuadro">D</div>
      <div class="cuadro">E</div>
      <div class="cuadro">F</div>
      <div class="cuadro">G</div>
      <div class="cuadro">H</div>
    </div>
    <div id="imagen-container">
      <img id="camara" src="" width="640" height="480">
    </div>
    <p id="cls-value"></p>
    <button id="connect-btn" onclick="toggleConnection()">Conectar</button>
    <button id="disconnect-btn" onclick="toggleConnection()" disabled>Desconectar</button>
    <script>
      const imgContainer = document.getElementById('imagen-container');
      const clsValueElement = document.getElementById('cls-value');
      const cuadros = document.getElementsByClassName('cuadro');
      let socket;
      let isConnected = false;

      function toggleConnection() {
        if (isConnected) {
          disconnectWebSocket();
        } else {
          connectWebSocket();
        }
      }

      function connectWebSocket() {
        if (isConnected) {
          console.log('Ya hay una conexión WebSocket abierta.');
          return;
        }

        socket = new WebSocket('ws://127.0.0.1:8000/ws'); // URL del endpoint WebSocket de tu aplicación FastAPI

        socket.onopen = function () {
          console.log('Conexión establecida');
          isConnected = true;
          document.getElementById('connect-btn').disabled = true;
          document.getElementById('disconnect-btn').disabled = false;
        };

        socket.onmessage = function (event) {
          const data = JSON.parse(event.data); // Parsear el mensaje JSON recibido

          if (data.image) {
            const imageBase64 = data.image;

            // Crear una nueva imagen en memoria
            const newImg = new Image();
            newImg.onload = function () {
              // Reemplazar la imagen anterior con la nueva
              imgContainer.innerHTML = '';
              imgContainer.appendChild(newImg);
            };
            newImg.src = 'data:image/jpeg;base64,' + imageBase64;
          }

          if (data.cls) {
            const clsValue = data.cls;
            clsValueElement.textContent = 'Valor de cls: ' + clsValue; // Mostrar el valor de cls en el elemento HTML

            // Reiniciar el color de todos los cuadros
            for (let i = 0; i < cuadros.length; i++) {
              cuadros[i].classList.remove('verde');
            }

            // Cambiar el color del cuadro correspondiente si cls coincide con alguna letra
            const cuadroIndex = clsValue.charCodeAt(0) - 65; // Obtener el índice del cuadro basado en el valor de cls (A=65)
            if (cuadroIndex >= 0 && cuadroIndex < cuadros.length) {
              cuadros[cuadroIndex].classList.add('verde');
            }
          }
        };

        socket.onclose = function (event) {
          console.log('Conexión cerrada: ', event);
          isConnected = false;
          document.getElementById('connect-btn').disabled = false;
          document.getElementById('disconnect-btn').disabled = true;
          resetImage();
        };
      }

      function disconnectWebSocket() {
        if (socket) {
          socket.close();
          console.log('Conexión WebSocket cerrada');
        }
      }

      function resetImage() {
        imgContainer.innerHTML = '';
      }

    </script>
  </body>
</html>